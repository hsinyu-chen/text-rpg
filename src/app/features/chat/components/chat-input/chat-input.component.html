<div class="input-area" [class.editing-mode]="editingMessageId()">
    <div class="input-wrapper">

        <!-- Mobile Menu Trigger -->
        <button mat-mini-fab class="mobile-menu-btn" [matMenuTriggerFor]="mobileMenu"
            [disabled]="state.status() === 'generating'">
            <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #mobileMenu="matMenu">
            <button mat-menu-item (click)="toggleSidebar.emit()">
                <mat-icon>history</mat-icon>
                <span>Turn Updates</span>
            </button>
            <button mat-menu-item (click)="saveProgress()">
                <mat-icon>save</mat-icon>
                <span>Save Progress</span>
            </button>
            <button mat-menu-item (click)="openConfigDialog()">
                <mat-icon>settings</mat-icon>
                <span>Config</span>
            </button>
            <button mat-menu-item (click)="exportToMarkdown()">
                <mat-icon>file_download</mat-icon>
                <span>Export MD</span>
            </button>
            <button mat-menu-item (click)="openReplaceDialog()">
                <mat-icon>find_replace</mat-icon>
                <span>{{ lang.t('BATCH_REPLACE') }}</span>
            </button>
            <button mat-menu-item (click)="openPayloadPreview()">
                <mat-icon>visibility</mat-icon>
                <span>Preview API</span>
            </button>
        </mat-menu>

        <!-- Save Button (Desktop) -->
        <button mat-mini-fab color="accent" class="save-btn desktop-only"
            [disabled]="state.status() === 'generating' || !state.isConfigured()" (click)="saveProgress()"
            matTooltip="Save Progress (Full Context)">
            <mat-icon>save</mat-icon>
        </button>

        <!-- Config Button (Desktop) -->
        <button mat-mini-fab class="config-btn desktop-only"
            [disabled]="state.status() === 'generating' || !state.isConfigured()" (click)="openConfigDialog()"
            matTooltip="Chat Config (Thinking Inject)">
            <mat-icon>settings</mat-icon>
        </button>

        <!-- Export Button (Desktop) -->
        <button mat-mini-fab color="primary" class="export-btn desktop-only"
            [disabled]="state.status() === 'generating' || state.messages().length === 0" (click)="exportToMarkdown()"
            matTooltip="Export Story to MD">
            <mat-icon>file_download</mat-icon>
        </button>

        <!-- Batch Replace Button (Desktop) -->
        <button mat-mini-fab color="primary" class="replace-btn desktop-only"
            [disabled]="state.status() === 'generating' || state.messages().length === 0" (click)="openReplaceDialog()"
            [matTooltip]="lang.t('BATCH_REPLACE')">
            <mat-icon>find_replace</mat-icon>
        </button>

        <!-- Turn Updates History Button -->
        <button mat-mini-fab class="history-btn desktop-only" [disabled]="state.status() === 'generating'"
            (click)="toggleSidebar.emit()" matTooltip="View Turn Updates">
            <mat-icon>history</mat-icon>
        </button>

        <mat-form-field appearance="outline" class="intent-select">
            <mat-select [(ngModel)]="selectedIntent" panelClass="intent-select-panel"
                [disabled]="state.status() === 'generating' || !!editingMessageId()">
                <mat-select-trigger>
                    <div class="intent-trigger">
                        <mat-icon [style.color]="getIntentColor(selectedIntent())">{{ getIntentIcon(selectedIntent()) }}</mat-icon>
                        <span [style.color]="getIntentColor(selectedIntent())">{{ getIntentLabel(selectedIntent()) }}</span>
                    </div>
                </mat-select-trigger>

                @for (intent of intents; track intent) {
                <mat-option [value]="intent">
                    <div class="intent-option">
                        <div class="intent-header">
                            <mat-icon [style.color]="getIntentColor(intent)">{{ getIntentIcon(intent) }}</mat-icon>
                            <span class="intent-label" [style.color]="getIntentColor(intent)">{{ getIntentLabel(intent) }}</span>
                        </div>
                        <div class="intent-description">{{ getIntentDescription(intent) }}</div>
                    </div>
                </mat-option>
                }
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="main-input">
            <mat-label>{{ editingMessageId() ? 'Editing Mode. Ctrl+Enter to save.' : (dynamicPlaceholder() || 'Enter
                your action...')
                }}</mat-label>
            <textarea #messageInput matInput cdkTextareaAutosize cdkAutosizeMinRows="1" cdkAutosizeMaxRows="5"
                [(ngModel)]="userInput" (keydown)="onEnter($event)" (focus)="onInteraction()" (click)="onInteraction()"
                (blur)="onBlur()" [disabled]="state.status() === 'generating'"></textarea>

            @if (editingMessageId()) {
            <button mat-icon-button matSuffix (click)="cancelEdit()" matTooltip="Cancel Edit">
                <mat-icon>close</mat-icon>
            </button>
            }
        </mat-form-field>

        <button mat-mini-fab class="preview-btn desktop-only"
            [disabled]="state.status() === 'generating' || !state.isConfigured()" (click)="openPayloadPreview()"
            matTooltip="Preview API Payload">
            <mat-icon>visibility</mat-icon>
        </button>

        <button mat-mini-fab color="primary" class="send-btn" [disabled]="state.status() === 'generating'"
            (click)="sendMessage()" matTooltip="Send (Ctrl+Enter)">
            <mat-icon>send</mat-icon>
        </button>

    </div>
</div>