@if (message(); as msg) {
<!-- User Msg -->
@if (msg.role === 'user') {
<div class="msg-row user">
    <div class="msg-bubble user-bubble" [class.ref-only]="msg.isRefOnly">
        <!-- Toolbar for User Msg -->
        <div class="msg-toolbar">
            <button mat-icon-button class="mini-btn" (click)="state.toggleRefOnly()" [disabled]="isBusy()"
                [matTooltip]="msg.isRefOnly ? 'Include in Story' : 'Mark as Ref Only'">
                <mat-icon>{{ msg.isRefOnly ? 'link' : 'link_off' }}</mat-icon>
            </button>
            <!-- Rewind & Resend Button (Only Last User Msg) -->
            @if (isLastUser()) {
            <button mat-icon-button class="mini-btn" (click)="onEditAndResend()" [disabled]="isBusy()"
                matTooltip="Edit & Resend (Deletes subsequent history)">
                <mat-icon>history_edu</mat-icon>
            </button>
            }

            <button mat-icon-button class="mini-btn delete-btn" (click)="state.deleteMessageAndFollowing()"
                [disabled]="isBusy()" matTooltip="Delete This and All Following">
                <mat-icon>delete_sweep</mat-icon>
            </button>
            <button mat-icon-button class="mini-btn delete-btn" (click)="state.deleteMessage()" [disabled]="isBusy()"
                matTooltip="Delete Message">
                <mat-icon>delete</mat-icon>
            </button>
        </div>
        <div (dblclick)="state.enterEditMode()" class="bubble-content">

            @if (!state.isEditing()) {
            <div class="text-content">{{ msg.content | stripIntent }}</div>
            } @else {
            <ng-container *ngTemplateOutlet="editor" />
            }

        </div>
        <div class="msg-meta">
            @if (msg.intent) { <span class="intent-tag" [class.system]="msg.intent === Intents.SYSTEM"
                [class.save]="msg.intent === Intents.SAVE">{{ getIntentLabel(msg.intent) }}</span> }
            User Action @if (msg.isRefOnly) { <span>(Ref Only)</span> }
        </div>
    </div>
</div>
}

<!-- Model Msg -->
@if (msg.role === 'model') {
<div class="msg-row model">
    <div class="msg-wrapper">
        <div class="msg-bubble model-bubble group" [class.ref-only]="msg.isRefOnly">

            <!-- Toolbar -->
            <div class="msg-toolbar">
                @if (msg.intent === Intents.SAVE || msg.content.includes('<save')) { <button mat-icon-button
                    class="mini-btn update-btn" (click)="state.openAutoUpdateDialog()" [disabled]="isBusy()"
                    matTooltip="Auto Update Files">
                    <mat-icon>auto_fix_high</mat-icon>
                    </button>
                    }
                    <button mat-icon-button class="mini-btn" (click)="state.copyPairJSON()" [disabled]="isBusy()"
                        matTooltip="Copy JSON Pair (User+Model)">
                        <mat-icon>content_copy</mat-icon>
                    </button>
                    <button mat-icon-button class="mini-btn" (click)="state.toggleRaw()" [disabled]="isBusy()"
                        matTooltip="Toggle Raw/Render">
                        <mat-icon>code</mat-icon>
                    </button>
                    <button mat-icon-button class="mini-btn" (click)="state.enterEditMode()" [disabled]="isBusy()"
                        matTooltip="Edit Text">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button class="mini-btn" (click)="state.toggleRefOnly()" [disabled]="isBusy()"
                        [matTooltip]="msg.isRefOnly ? 'Include in Story' : 'Mark as Ref Only'">
                        <mat-icon>{{ msg.isRefOnly ? 'link' : 'link_off' }}</mat-icon>
                    </button>
                    <button mat-icon-button class="mini-btn delete-btn" (click)="state.deleteMessageAndFollowing()"
                        [disabled]="isBusy()" matTooltip="Delete This and All Following">
                        <mat-icon>delete_sweep</mat-icon>
                    </button>
                    <button mat-icon-button class="mini-btn delete-btn" (click)="state.deleteMessage()"
                        [disabled]="isBusy()" matTooltip="Delete Message">
                        <mat-icon>delete</mat-icon>
                    </button>
            </div>

            <!-- Context Status Indicator (If older than 5 turns) -->
            @if (!state.inContext() && msg.role === 'model' && !msg.isRefOnly) {
            <div class="context-status" matTooltip="Referenced by Summary Only (Context Optimized)">
                <mat-icon>history</mat-icon>
                <span>Archived</span>
            </div>
            }

            <!-- Ref Only Collapsible Wrapper -->
            @if (msg.isRefOnly && !state.isRefExpanded()) {
            <div class="ref-only-collapsed" (click)="state.toggleRefExpanded()"
                (keydown.enter)="state.toggleRefExpanded()" tabindex="0" matTooltip="Click to Expand">
                <span class="collapsed-text">{{ msg.content.slice(0, 50) }}...</span>
                <mat-icon class="expand-icon">expand_more</mat-icon>
            </div>
            } @else {

            <!-- Analysis Section (Atomic Breakdown) -->
            @if (msg.analysis) {
            <div class="thought-container analysis-container">
                <div class="thought-header analysis-header" (click)="state.toggleAnalysis()" tabindex="0"
                    (keydown.enter)="state.toggleAnalysis()"
                    (keydown.space)="$event.preventDefault(); state.toggleAnalysis()">
                    <div class="header-main">
                        <mat-icon>{{ state.isAnalysisVisible() ? 'expand_more' : 'chevron_right' }}</mat-icon>
                        <mat-icon class="brain-icon">fact_check</mat-icon>
                        <span>Atomic Breakdown & Check</span>
                    </div>
                </div>
                @if (state.isAnalysisVisible()) {
                <div class="thought-content">
                    <markdown [data]="msg.analysis | wrapSaveXml"></markdown>
                </div>
                }
            </div>
            }

            <!-- Thought Section -->
            @if (msg.thought) {
            <div class="thought-container" [class.streaming]="msg.isThinking">
                <div class="thought-header" (click)="state.toggleThought()" tabindex="0"
                    (keydown.enter)="state.toggleThought()"
                    (keydown.space)="$event.preventDefault(); state.toggleThought()">
                    <div class="header-main">
                        <mat-icon>{{ state.isThoughtVisible() || msg.isThinking ? 'expand_more' : 'chevron_right'
                            }}</mat-icon>
                        <mat-icon class="brain-icon">psychology</mat-icon>
                        <span>Model Thought Process</span>
                    </div>
                    @if (msg.isThinking) {
                    <div class="header-status">
                        Thinking...
                    </div>
                    }
                </div>
                @if (state.isThoughtVisible()) {
                <div class="thought-content">
                    <markdown [data]="msg.thought | wrapSaveXml"></markdown>
                </div>
                }
            </div>
            }

            <!-- Turn Update Section -->
            @if (msg.summary || (msg.inventory_log?.length ?? 0) > 0 || (msg.quest_log?.length ?? 0) >
            0 || (msg.world_log?.length ?? 0) > 0) {
            <div class="thought-container update-panel-container">
                <div class="thought-header update-panel-header" (click)="state.toggleUpdate()" tabindex="0"
                    (keydown.enter)="state.toggleUpdate()"
                    (keydown.space)="$event.preventDefault(); state.toggleUpdate()">
                    <div class="header-main">
                        <mat-icon>{{ state.isUpdateVisible() ? 'expand_more' : 'chevron_right' }}</mat-icon>
                        <mat-icon class="brain-icon">update</mat-icon>
                        <span>Turn Update</span>
                    </div>
                </div>
                @if (state.isUpdateVisible()) {
                <div class="thought-content">
                    <app-turn-update [message]="msg" />
                </div>
                }
            </div>
            }


            @if (!state.isEditing()) {
            <!-- Rendered Mode -->
            @if (!state.isRaw()) {
            <div (dblclick)="state.enterEditMode()" class="prose-content">
                <markdown [data]="msg.content | stripSavePoint | wrapSaveXml"></markdown>
            </div>
            @if (hasSavePoint()) {
            <div class="save-point-section">
                <hr class="save-point-divider">
                <button mat-stroked-button color="primary" class="save-point-btn" (click)="state.triggerSaveFlow()"
                    [disabled]="isBusy()">
                    <mat-icon>save</mat-icon>
                    結束目前ACT並產生檔案更新
                </button>
            </div>
            }
            }

            <!-- Raw Mode -->
            @if (state.isRaw()) {
            <div (dblclick)="state.enterEditMode()" class="raw-content">
                {{ msg.content }}
            </div>
            }
            } @else {
            <ng-container *ngTemplateOutlet="editor" />
            }
            @if (msg.isRefOnly) {
            <div class="ref-only-collapse-footer" (click)="state.toggleRefExpanded()"
                (keydown.enter)="state.toggleRefExpanded()" tabindex="0" matTooltip="Collapse">
                <mat-icon>expand_less</mat-icon>
            </div>
            }

            }

            <div class="msg-meta">
                @if (msg.intent) { <span class="intent-tag" [class.system]="msg.intent === Intents.SYSTEM"
                    [class.save]="msg.intent === Intents.SAVE">{{ getIntentLabel(msg.intent) }}</span> }
                @if (msg.isCorrection) { <span class="correction-tag">(修正)</span> }
                Model Response @if (msg.isRefOnly) { <span>(Ref Only)</span> }

            </div>
        </div>
    </div>
</div>
}
}

<!-- Editor Template (Shared) -->
<ng-template #editor>
    <div class="editor-box">
        <mat-form-field class="editor-field" appearance="outline">
            <textarea matInput cdkTextareaAutosize [ngModel]="state.editContent()"
                (ngModelChange)="state.editContent.set($event)"
                (keydown.control.enter)="state.saveEdit(); $event.preventDefault()"
                (keydown.meta.enter)="state.saveEdit(); $event.preventDefault()">
            </textarea>
        </mat-form-field>
        <div class="editor-actions">
            <button mat-button color="warn" (click)="state.cancelEdit()">Cancel</button>
            <button mat-flat-button color="primary" (click)="state.saveEdit()">Save</button>
        </div>
    </div>
</ng-template>