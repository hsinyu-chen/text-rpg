<div class="status-indicator" [class]="state.status()">
    <div class="status-header">
        <div class="status-dot"></div>
        <span class="status-text">{{ state.status() | uppercase }}</span>
    </div>

    <!-- Last Turn Breakdown -->
    <div class="turn-stats">
        @if (state.loadedFiles().size > 0 && !state.kbCacheName()) {
        <div class="kb-warning">
            <mat-icon>warning</mat-icon>
            <span>KB changed. Next send will rebuild cache.</span>
        </div>
        }
        @if (computedLastTurnUsage(); as turn) {
        <div class="stat-header">LAST TURN</div>
        <div class="stat-row turn"><span>New:</span> <span class="val">{{ (turn.prompt - turn.cached) | number }}</span>
        </div>
        <div class="stat-row turn-cached"><span>Cached:</span> <span class="val">{{ turn.cached | number }}</span>
        </div>
        <div class="stat-row turn-total"><span>Total Input:</span> <span class="val">{{ turn.prompt | number }}</span>
        </div>
        <div class="stat-row turn"><span>Output:</span> <span class="val">{{ turn.candidates | number }}</span></div>
        <div class="stat-row turn-total">
            <span>Last Turn Est. Cost:</span>
            <span class="val">{{ (lastTurnCost() * displayRate()) |
                currency:displayCurrency():'symbol-narrow':(displayCurrency() === 'USD' ? '1.4-6' : '1.2-2') }}</span>
        </div>
        }
    </div>

    @if (activeUsage(); as usage) {
    <div class="token-stats">
        <div class="stat-header">SESSION TOTAL</div>
        <div class="stat-row" matTooltip="Number of model responses in this session"><span>Turns:</span> <span
                class="val">{{ turnCount() }}</span></div>
        <div class="stat-row" matTooltip="Tokens sent for the first time"><span>New Input:</span> <span class="val">{{
                usage.freshInput | number }}</span></div>
        <div class="stat-row cached"
            matTooltip="Implicit Caching is WORKING when this is > 0. These are FREE/Discounted tokens.">
            <span>Cached:</span> <span class="val">{{ usage.cached | number }}</span>
        </div>
        <div class="stat-row"><span>Output:</span> <span class="val">{{ usage.output | number }}</span></div>

        @if (state.kbCacheName()) {
        <div class="stat-row storage"
            matTooltip="Real-time cost increment for active context cache. Rate: $1.00 - $4.50/1M/hr">
            <span>Storage Cost:</span>
            <span class="val">{{ (activeStorageCostDisplay() * displayRate()) |
                currency:displayCurrency():'symbol-narrow':(displayCurrency() === 'USD' ? '1.4-6' : '1.2-2') }}</span>
        </div>
        }

        @if (historyStorageCostDisplay() > 0) {
        <div class="stat-row storage history"
            matTooltip="Accumulated storage cost from previous/deleted caches in this session.">
            <span>Hist. Cache Cost:</span>
            <span class="val">{{ (historyStorageCostDisplay() * displayRate()) |
                currency:displayCurrency():'symbol-narrow':(displayCurrency() === 'USD' ? '1.4-6' : '1.2-2') }}</span>
        </div>
        }

        @if (state.cacheCountdown()) {
        <div class="stat-row expiry">
            <span>Cache Expiry:</span>
            <span class="val" [class.warning]="state.cacheCountdown() === 'EXPIRED'">{{ state.cacheCountdown()
                }}</span>
        </div>
        }

        <div class="stat-row total" matTooltip="Sum of all tokens processed in this session"><span>Total
                Sent:</span> <span class="val">{{ usage.total | number }}</span></div>
        <div class="stat-row cost"
            [matTooltip]="'Estimated total cost (Transactions + Storage) converted to ' + displayCurrency()">
            <span>Total Est. Cost({{ displayCurrency() }}):</span>
            <span class="val">{{ (totalSessionCost() * displayRate()) |
                currency:displayCurrency():'symbol-narrow':(displayCurrency() === 'USD' ? '1.4-6' : '1.2-2') }}</span>
        </div>
        <div class="stat-actions">
            <button mat-icon-button class="action-btn" (click)="openCostComparison()" matTooltip="Compare Model Costs">
                <mat-icon>compare_arrows</mat-icon>
            </button>
            <button mat-icon-button class="action-btn" (click)="copySessionStats()"
                matTooltip="Copy Stats to Clipboard">
                <mat-icon>content_copy</mat-icon>
            </button>
        </div>
    </div>
    }
</div>