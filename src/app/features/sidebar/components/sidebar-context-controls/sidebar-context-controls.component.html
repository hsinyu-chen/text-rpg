@if (state.loadedFiles().size > 0 && state.messages().length === 0) {
<button mat-flat-button color="accent" (click)="startSession()" [disabled]="state.isBusy()" class="full-width start-btn"
    style="margin-top: 8px; font-weight: bold;">
    <mat-icon>play_arrow</mat-icon>
    Initialize Story
</button>
}

<button mat-flat-button color="primary" (click)="newGame()" [disabled]="state.isBusy()" class="full-width new-game-btn"
    style="margin-top: 8px; font-weight: bold; background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);">
    <mat-icon>add_circle</mat-icon>
    Start New Game
</button>


@if (state.kbCacheName()) {
<button mat-stroked-button color="warn" (click)="releaseCache()" [disabled]="state.isBusy()"
    class="full-width release-btn" style="margin-top: 8px;">
    <mat-icon>phonelink_erase</mat-icon>
    Release Current Cache
</button>
}

<button mat-stroked-button color="warn" (click)="clearHistory()"
    [disabled]="state.messages().length === 0 || state.isBusy()" class="full-width restart-btn">
    <mat-icon>delete_sweep</mat-icon>
    Restart Session
</button>

<button mat-flat-button color="accent" (click)="saveAndNext()"
    [disabled]="state.messages().length === 0 || state.isBusy() || !hasStorageTarget()" class="full-width save-next-btn"
    [matTooltip]="!hasStorageTarget() ? 'Please select a Local Folder or Cloud Slot first' : ''"
    style="margin-top: 8px; margin-bottom: 8px; font-weight: bold; background: linear-gradient(45deg, #11998e 0%, #38ef7d 100%); color: white;">
    <mat-icon>auto_awesome</mat-icon>
    Save & Next
</button>

<button mat-stroked-button color="warn" (click)="clearAllRemoteData()" [disabled]="state.isBusy()"
    class="full-width clear-all-btn">
    <mat-icon>cloud_off</mat-icon>
    Wipe Remote Data & Reset
</button>

<button mat-stroked-button color="warn" (click)="wipeLocalSession()" [disabled]="state.isBusy()"
    class="full-width wipe-local-btn" style="margin-top: 8px;">
    <mat-icon>delete_forever</mat-icon>
    Wipe Local Session
</button>

<mat-divider style="margin: 16px 0"></mat-divider>

@if (state.estimatedKbTokens() > 0) {
<p class="hint-text info-strong">
    Est. Cache Size: <strong>{{ state.estimatedKbTokens() | number }}</strong>
</p>
}
<div class="toggle-section">
    <button mat-stroked-button class="full-width mode-btn" (click)="toggleContextMode()" [disabled]="state.isBusy()"
        [class.active-smart]="state.contextMode() === 'smart'"
        [class.active-summarized]="state.contextMode() === 'summarized'"
        [class.active-full]="state.contextMode() === 'full'">
        <mat-icon>{{ state.contextMode() === 'smart' ? 'compress' : (state.contextMode() === 'summarized' ?
            'auto_stories' : 'expand') }}</mat-icon>
        Mode: {{ state.contextMode() === 'smart' ? 'Smart' : (state.contextMode() === 'summarized' ? 'Summarized' :
        'Full') }}
    </button>
    <p class="hint-text">
        @if (state.contextMode() === 'smart') {
        Older turns summarized + Last 10 Turns Full
        } @else if (state.contextMode() === 'summarized') {
        Older turns summarized + Last 1 Turn Full
        } @else {
        Sends 100% full history (High Cost)
        }
    </p>

    <mat-divider style="margin: 8px 0"></mat-divider>

    <button mat-stroked-button class="full-width mode-btn" (click)="toggleSaveContextMode()" [disabled]="state.isBusy()"
        [class.active-smart]="state.saveContextMode() === 'smart'"
        [class.active-summarized]="state.saveContextMode() === 'summarized'"
        [class.active-full]="state.saveContextMode() === 'full'">
        <mat-icon>{{ state.saveContextMode() === 'smart' ? 'compress' : (state.saveContextMode() === 'summarized' ?
            'auto_stories' : 'expand') }}</mat-icon>
        Save Mode: {{ state.saveContextMode() === 'smart' ? 'Smart' : (state.saveContextMode() === 'summarized' ?
        'Summarized' : 'Full') }}
    </button>
    <p class="hint-text">
        Context mode used for &lt;存檔&gt; tags
    </p>
</div>