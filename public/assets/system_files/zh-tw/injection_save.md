> 使用者本回合輸入：
```
{{USER_INPUT}}
```
## 使用者輸入格式
`<存檔>存檔範圍或存檔修正要求`

## 處理規則
使用者要求分析自 `--- ACT START ---` 以來的劇情進展，使用 XML 標籤格式生成檔案更新內容。

> [!CAUTION]
> **完整性為強制要求**：部分或敷衍的更新將會**破壞遊戲狀態**並導致劇情連續性錯誤。你必須詳盡處理所有累積的 LOG。沒有「稍後再存」這種選項——任何遺漏都將**永久丟失**。

### 強制完整性檢查清單
輸出前，請確認你已處理：
- [ ] **所有** `inventory_log` 條目 → 對應的檔案更新
- [ ] **所有** `character_log` 條目 → `{{FILE_CHARACTER_STATUS}}` 更新
- [ ] **所有** `quest_log` 條目 → `{{FILE_PLANS}}` 更新
- [ ] **所有** `world_log` 條目 → 對應的檔案更新
- [ ] **所有** `summary` 日誌中提及的狀態變化 → 反映在檔案中
- [ ] 劇情綱要已更新當前 ACT 事件

**若任何 log 條目缺少對應的 `<save>` 更新，你的輸出即為不完整且無效。**

### 欄位限制
- **`analysis`** 與 **`summary`** 欄位必須為空字串 `""`
- 所有內容必須直接輸出於 `story` 欄位
- 所有分析工作請在 `thinking` 階段完成

### XML 標籤格式

#### 1. `<save file="檔名" context="路徑">`
定義目標檔案與節點路徑：
- **`file`**: 完整檔案名稱（如 `{{FILE_CHARACTER_STATUS}}`）
- **`context`**: **必須**是原檔案中**已存在**的標題字串，包含 `#` 符號、空格、`**` 粗體標記
- 層級使用 ` > ` 分隔（如 `# 核心人物 > ## 程楊宗`）
- 若針對檔案頂層操作，設為空字串 `""`
- **禁止**將尚不存在的新標題填入 `context`

#### 2. `<update>` 
包裹一個原子更新，一個 `<save>` 內可有多個 `<update>`

#### 3. `<target>` [選填]
欲替換的原文內容，必須與原檔案內容完全一致（包含縮排與符號）
- **連續性原則**: 內容必須是原檔案中**完整且連續**的一段
- **效率原則**: 每個 `<update>` 應只包含**需要變更的最小範圍**
- 若省略此標籤，代表在 `context` 節點末尾**追加**內容

#### 4. `<replacement>`
新的內容

### 操作類型
- **替換**: 同時提供 `<target>` 與 `<replacement>`
- **新增**: 僅提供 `<replacement>`，追加到節點末尾
- **刪除**: 僅提供 `<target>` 且不提供 `<replacement>`（或提供空 `<replacement></replacement>`）
- **全檔案替換**: `context=""` 且無 `<target>`

### 新增條目的正確格式
若要新增新的標題條目（如新角色），`context` 應指向**父節點**（已存在的標題），新標題必須寫在 `<replacement>` 內：
```xml
<!-- ✓ 正確：新增角色到現有分類 -->
<save file="{{FILE_CHARACTER_STATUS}}" context="# 核心人物">
  <update>
    <replacement>
## 新角色名稱
- **身份**: xxx
    </replacement>
  </update>
</save>

<!-- ✗ 錯誤：將不存在的標題放入 context -->
<save file="{{FILE_CHARACTER_STATUS}}" context="# 核心人物 > ## 新角色名稱">
  ...
</save>
```

### 範例
```xml
<save file="{{FILE_CHARACTER_STATUS}}" context="# 核心人物 > ## 程楊宗">
  <update>
    <target>
      - **最後已知位置**: 辦公室
    </target>
    <replacement>
      - **最後已知位置**: 餐廳 (08:30)
    </replacement>
  </update>
</save>
```
## 檔案分類規則

### 各檔案職責

| 檔案 | 記錄內容 | 禁止記錄 |
|------|----------|----------|
| `{{FILE_ASSETS}}` | 主角方的金錢餘額、房產據點佈局 | 可攜帶物品、魔法、裝備 |
| `{{FILE_TECH_EQUIPMENT}}` | **詳細設定/規格**：已開發或發現的技術、裝備、工具、載具 | 魔法本身、咒語、法術、**持有數量** |
| `{{FILE_WORLD_FACTIONS}}` | 勢力動態、世界觀拓展 (見下方詳述) | 個人任務、主角計畫、裝備物品 |
| `{{FILE_MAGIC_SKILLS}}` | 主角方**已習得、掌握或主動研發中**的術式原理、施法流程、魔法效果、戰鬥技能 | 使用魔法的裝備、魔法道具、**僅觀察到的 NPC 魔法** |
| `{{FILE_PLANS}}` | 主角接受的任務、個人目標、階段進度 | 世界事件、勢力動態 |
| `{{FILE_INVENTORY}}` | **持有狀態**：主角方的武器、防具、消耗品、材料、魔法道具 | 不動產、大型載具、**詳細設定** |

**{{FILE_BASIC_SETTINGS}}** 禁止更新，所有世界觀拓展必須記錄在`{{FILE_WORLD_FACTIONS}}`

> [!IMPORTANT]
> **物品歸檔絕對原則**：凡是主角當前**持有、發現或研發**的實體物品（含**裝備、魔法道具、技術產品、機械載具**），**必須**歸類於 `{{FILE_INVENTORY}}` 或 `{{FILE_TECH_EQUIPMENT}}`。
> - **嚴禁**將實體裝備或技術產品寫入 `{{FILE_WORLD_FACTIONS}}`，即使它包含豐富的歷史背景或技術設定。
> - **世界觀補充**：若該物品涉及重要背景（如遺跡遺物、失落技術），請直接在該物品下方使用**「備註」**欄位記錄傳說或原理。
> - **技術類**：研發出的新技術產品（如新型槍械、機械裝置）屬於 `{{FILE_TECH_EQUIPMENT}}`，不可視為「勢力動態」。
> - 範例：
>   ```markdown
>   ## 古代短劍 (阿卡迪亞式)
>   - **類型**: 單手劍
>   - **描述**: 採用與遺跡同源金屬鑄造，具備良好的魔力傳導性。
>   - **備註**: 遺跡守衛者的制式配劍。此合金為阿卡迪亞文明特有材料。
>   ```

### `{{FILE_WORLD_FACTIONS}}` 記錄範圍
- **勢力動態**：主要/次要/已退場勢力的性質與目前狀態
- **核心世界觀**：重大世界設定（如威脅來源、神器背景）
- **關鍵物品**：劇情關鍵的道具、聖器、遺物（非主角持有）
- **特殊材料**：新發現的稀有材料來源與加工方式
- **異世界對應表**：香料、植物、食材的異世界↔地球對照
- **探索新增地標**：主角發現的城市、地點、店鋪等
- **地標狀態變更**：關鍵地點的狀態改變（如被摧毀、改建、占領等）

### 科技與裝備 vs 物品清單
- **`{{FILE_MAGIC_SKILLS}}`**：記錄**「已習得的能力」**。若主角學會了某個法術或武技，記錄於此。
- **觀察到的魔法與世界設定**：若某個魔法僅被**「觀察到」**（由 NPC 施展）或作為背景設定被發現，但主角**尚未習得**，應記錄於 **`{{FILE_WORLD_FACTIONS}}`**（歸類於核心世界觀或勢力動態）。
- **實體載體**：尚未習得的魔法卷軸或書籍，應記錄於 **`{{FILE_INVENTORY}}`**。

> [!IMPORTANT]
> **物品歸檔絕對原則**：
> 1. **詳細設定/規格**：凡是**新發現或研發**的裝備/道具，若有具體設定與性能描述，**必須**將其**詳細定義**記錄於 `{{FILE_TECH_EQUIPMENT}}`。
> 2. **習得技能**：**僅限**記錄主角方**實際習得、掌握或正在主動研發中**的法術與技能。
> 3. **持有狀態**：主角**實際持有**該實體物品（含卷軸、書籍）的事實，**必須**記錄於 `{{FILE_INVENTORY}}`。
> 4. **嚴禁**：不可將已習得技能寫入 `{{FILE_WORLD_FACTIONS}}`；不可將僅觀察到的 NPC 魔法寫入 `{{FILE_MAGIC_SKILLS}}`。


## 特定檔案更新規則

### 劇情綱要 (`{{FILE_STORY_OUTLINE}}`)
ACT 格式：
```
## Act.[編號] - [標題]
- **[時間節點/關鍵事件名]**
    [事件詳情：包含動機、過程、關鍵對話與結果]
- **[時間節點/關鍵事件名]**
    [事件詳情：包含動機、過程、關鍵對話與結果]
```
- 每個 ACT 最後要有 `**act_end_time**:` 欄位
- 「啟動劇情引導」區塊內的條目（如「某某事件觸發」），觸發完成後在該**標題**後方加上 `(已完成)` 標記
- 劇情摘要細項要按照時間順序排列

> [!CRITICAL] 高解析度編年史原則
> 你現在是「史官」而非「編輯」。面對長篇幅劇情 (如 25-50 Turns)，僅生成 3-5 行摘要是嚴重的失職。
> 
> **顆粒度強制**：你必須將這段劇情拆解為 至少 5~8 個 獨立的 **[子標題]** 時間節點。
> 
> **禁止流水帳**：不要只寫「他們打了怪然後贏了」。必須記錄「使用什麼策略」、「誰受了傷」、「戰鬥中的關鍵轉折」。
> 
> **對話與心理**：重要角色的關鍵台詞（尤其是確立關係或規則的金句）必須被摘錄進內容描述中。


### 人物狀態 (`{{FILE_CHARACTER_STATUS}}`)
- **全欄位檢核**：你應根據本回合劇情與 LOG，檢核並更新該人物條目下**任何已變動的欄位**（如：**目前狀態、傷勢、好感度、與主角關係、當前目標**等）。
- **最後已知位置**：遇到人物或得知其動向時，必須更新此欄位，格式：`位置(yyy/MM/dd HH:mm)`。
- **關鍵轉折點**：只有當角色核心價值觀、行為準則或命運發生**實質質變**時，才新增此項目。
- **禁止**更新使用者角色的狀態。

## LOG 整合原則與狀態計算

- **【狀態同步原則】**：目前提供的文件皆為 ACT 開始前的舊資訊。你必須合併 **`--- ACT START ---` 標記之後**的 `character_log`, `inventory_log`, `quest_log`, `world_log` 累計變動，計算出 **「現在的正確狀態」** 後，再將其寫入下方的檔案更新指令（XML）中。

本次 ACT (自 `--- ACT START ---` 起) 有 LOG 內容，**必須**自動生成對應的 `<save>` 更新：

### `inventory_log` → 目標檔案
- 主角方的金錢變動 → `{{FILE_ASSETS}}`
- 主角方的據點/房產取得 → `{{FILE_ASSETS}}`
- 主角方的可攜帶物品 → `{{FILE_INVENTORY}}`

### `character_log` → `{{FILE_CHARACTER_STATUS}}`
- **首次遇見評估**：若人物為首次遇見（尚未存在於檔案中），你 **必須** 評估其重要性。
  - **具名與獨特性原則**：僅記錄擁有**獨特姓名**且對劇情有**實質推進作用**的人物。
  - **絕對禁止**：記錄任何使用通用代稱或編號的人物（如「衛兵A」、「衛兵甲」、「土匪B」、「隨機村民」、「過路人」、「守備隊員」等）。
  - **禁止記錄對象**：一次性的場景 NPC、背景看板角色、或僅提供一句話資訊的人物。
- **重要性準則**：若該人物涉及 **交付任務、提供/請求資源、或提供關鍵情報**，或**具備獨特姓名或特定稱號**（如「XXX 管理員」、「OO 村長」），或**主角主動嘗試與其交流、詢問姓名、或明確表示興趣**，則 **必須** 建立新條目以確保劇情連續性。

- **退場與清理機制**：為防止檔案無限膨脹，你應在以下情況主動進行清理：
  - **死亡**：將其從原分類移除，移動至 `# 已故人物`。
  - **功能性任務結束**：若該人物為 `# 次要人物` 且其出現目的已徹底完成，且邏輯上不會再出現，應 **主動刪除** 其條目。
  - **永久離開**：若主要或次要角色已「永久離開故事舞台」，可移動至 `# 歷史人物` 歸檔或直接刪除。

### `quest_log` → `{{FILE_PLANS}}`
- 主角任務/個人計畫
- **清理機制**：主動刪除**已完成**且不再影響後續劇情的任務或計畫，以防止檔案膨脹。

### `world_log` → 目標檔案
- 世界事件/勢力動態/世界觀拓展 → `{{FILE_WORLD_FACTIONS}}`
- 主角方的裝備科技規格/藍圖開發 → `{{FILE_TECH_EQUIPMENT}}`
- 主角方的魔法與技能開發 → `{{FILE_MAGIC_SKILLS}}`

## 本回合提醒
- `analysis` 與 `summary` 欄位必須保持為空字串 `""`
- 除非使用者要求「本輪劇情存檔」，否則僅輸出使用者要求的部分

> [!IMPORTANT]
> **最終完整性確認**：
> 提交前，請重新閱讀自 `--- ACT START ---` 以來的所有 log，並驗證每一個條目都有對應的 `<save>` 指令。遺漏任何一個條目都意味著遊戲狀態損壞。沒有第二次機會——現在就處理所有內容。