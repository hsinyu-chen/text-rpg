***
# 存檔指令 <存檔>

## 使用者輸入格式
`<存檔>存檔範圍或存檔修正要求`

## 處理規則
使用者要求分析本次劇情進展，使用 XML 標籤格式生成檔案更新內容。

### 欄位限制
- **`analysis`** 與 **`summary`** 欄位必須為空字串 `""`
- 所有內容必須直接輸出於 `story` 欄位
- 所有分析工作請在 `thinking` 階段完成

### XML 標籤格式

#### 1. `<save file="檔名" context="路徑">`
定義目標檔案與節點路徑：
- **`file`**: 完整檔案名稱（如 `{{FILE_CHARACTER_STATUS}}`）
- **`context`**: **完全按照原檔案中的標題字串**填寫，包含 `#` 符號、空格、`**` 粗體標記
- 層級使用 ` > ` 分隔（如 `# 核心人物 > ## 程楊宗`）
- 若針對檔案頂層操作，設為空字串 `""`

#### 2. `<update>` 
包裹一個原子更新，一個 `<save>` 內可有多個 `<update>`

#### 3. `<target>` [選填]
欲替換的原文內容，必須與原檔案內容完全一致（包含縮排與符號）
- **連續性原則**: 內容必須是原檔案中**完整且連續**的一段
- **效率原則**: 每個 `<update>` 應只包含**需要變更的最小範圍**
- 若省略此標籤，代表在 `context` 節點末尾**追加**內容

#### 4. `<replacement>`
新的內容

### 操作類型
- **替換**: 同時提供 `<target>` 與 `<replacement>`
- **新增**: 僅提供 `<replacement>`，追加到節點末尾
- **全檔案替換**: `context=""` 且無 `<target>`

### 範例
```xml
<save file="{{FILE_CHARACTER_STATUS}}" context="# 核心人物 > ## 程楊宗">
  <update>
    <target>
      - **最後已知位置**: 辦公室
    </target>
    <replacement>
      - **最後已知位置**: 餐廳 (08:30)
    </replacement>
  </update>
</save>
```
## 檔案分類規則

### 各檔案職責

| 檔案 | 用途 | 記錄內容 | 禁止記錄 |
|------|------|----------|----------|
| `{{FILE_ASSETS}}` | 金錢與不動產 | 現金餘額、房產據點佈局 | 可攜帶物品、魔法、裝備 |
| `{{FILE_TECH_EQUIPMENT}}` | 科技/機械裝置 | 機械原理的裝備、工具、載具 | 魔法本身、咒語、法術 |
| `{{FILE_WORLD_FACTIONS}}` | 世界局勢 | 勢力動態、世界觀拓展(發現的地點、動植物等) | 個人任務、主角計畫 |
| `{{FILE_MAGIC}}` | 魔法/法術/咒語 | 術式原理、施法流程、魔法效果 | 使用魔法的裝備、魔法道具 |
| `{{FILE_PLANS}}` | 主角任務與長期計畫 | 主角接受的任務、個人目標、階段進度 | 世界事件、勢力動態 |
| `{{FILE_INVENTORY}}` | 可攜帶物品 | 武器、防具、消耗品、材料、魔法道具 | 不動產、大型載具 |

**{{FILE_BASIC_SETTINGS}}** 禁止更新，所有事件觀拓展必須記錄在`{{FILE_WORLD_FACTIONS}}`

### 科技裝備 vs 魔法
- `{{FILE_TECH_EQUIPMENT}}`：記錄**物理裝置**（即使是「魔導裝備」，只要是裝備/工具/載具形式）
- `{{FILE_MAGIC}}`：記錄**術式本身**（純粹的法術、咒語、魔法能力）

## 特定檔案更新規則

### 劇情綱要 (`{{FILE_STORY_OUTLINE}}`)
ACT 格式：
```
## Act.[編號] - [標題]
- **[子標題]**
    [詳細內容描述]
```
- 每個 ACT 最後要有 `**act_end_time**:` 欄位
- 已完成的啟動劇情引導加上 `(已完成)` 標記

### 人物狀態 (`{{FILE_CHARACTER_STATUS}}`)
- 遇到人物時更新 **最後已知位置**，格式：`位置(yyy/MM/dd HH:mm)`
- 只有角色核心價值觀/行為準則發生**質變**時，才新增 `關鍵轉折點`
- **禁止**更新使用者角色的狀態

## LOG 整合規則

存檔範圍回合有 LOG 內容，**必須**自動生成對應的 `<save>` 更新：

| LOG 類型 | 內容 | 目標檔案 |
|----------|------|----------|
| `inventory_log` | 金錢變動 | `{{FILE_ASSETS}}` |
| `inventory_log` | 據點/房產取得 | `{{FILE_ASSETS}}` |
| `inventory_log` | 可攜帶物品 | `{{FILE_INVENTORY}}` |
| `quest_log` | 主角任務/個人計畫 | `{{FILE_PLANS}}` |
| `world_log` | 世界事件/勢力動態/世界觀拓展(地點、物產) | `{{FILE_WORLD_FACTIONS}}` |
| `world_log` | 裝備科技開發 | `{{FILE_TECH_EQUIPMENT}}` |
| `world_log` | 魔法開發 | `{{FILE_MAGIC}}` |

## 本回合提醒
- `analysis` 與 `summary` 欄位必須保持為空字串 `""`
- 除非使用者要求「本輪劇情存檔」，否則僅輸出使用者要求的部分
***
